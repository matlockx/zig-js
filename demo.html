<!DOCTYPE html>
<html>

<head>
    <style>
        #game {
            max-width: 30em;
            border: 2px solid red;
        }

        #events {
            background: #eee;
            font-family: monospace;
        }

        #events > div {
            padding: 0.5em;
            border-bottom: 2px solid #ddd;
        }
    </style>
</head>

<body>

<div>
    <a href="?game=dickehose">dickehose</a>
    <a href="?game=sofortlotto">sofortlotto</a>
    <a href="?game=cardcash">25 card cash</a>
</div>

<div id="game"></div>

<div id="sendCommands"></div>

<div id="events"></div>

<script src="dist/libint.js"></script>
<script src="demo-data.js"></script>

<script>
    const bootTime = Date.now();

    const gameName = (/game=([a-z]+)/.exec(location.search) || ["dummy", "dickehose"])[1];
    const gameData = GameDataObjects[gameName] || {};

    function logEvent(prefix, event) {
        const time = ((Date.now() - bootTime) * 0.001).toFixed(3) + "s";

        const div = document.createElement("pre");
        div.innerText = `${time}, ${prefix}:\n` + JSON.stringify(event, undefined, "  ");

        const container = document.querySelector("#events");
        container.insertBefore(div, container.firstChild);
    }

    function fakeRequestHandler(req) {
        let response = {statusCode: 404, body: ""};

        if (req.path.indexOf("/settle")) {
            response = {
                statusCode: 204,
                body: "",
            }
        }

        if (req.path.indexOf("/tickets")) {
            response = {
                statusCode: 200,
                body: JSON.stringify({
                    id: parseInt(100000 * Math.random()),
                    externalId: "demogame:" + parseInt(100000 * Math.random()),
                    ticketNumber: parseInt(100000 * Math.random()),
                    scenario: btoa(JSON.stringify(gameData.scenario)),
                    betFactor: gameData.betFactor || 1,
                    winningClass: {
                        number: 0,
                        numberOfTickets: -1,
                        winningsType: "NoWinning",
                        winnings: {
                            amount: "0.00",
                            amountInMajor: 0,
                            amountInMinor: 0,
                            currency: "EUR",
                        },
                    }
                }),
            };
        }

        if (req.path.indexOf("/demoticket")) {
            response = {
                statusCode: 200,
                body: JSON.stringify({
                    id: -1,
                    externalId: "demogame:00000",
                    ticketNumber: null,
                    scenario: btoa(JSON.stringify(gameData.scenario)),
                    betFactor: gameData.betFactor || 1,
                    winningClass: {
                        number: 2,
                        numberOfTickets: -1,
                        winningsType: "CashPrize",
                        winnings: {
                            amount: "2.00",
                            amountInMajor: 2,
                            amountInMinor: 0,
                            currency: "EUR",
                        },
                    }
                }),
            };
        }

        return Promise.resolve({response});
    }

    class Connector extends ZIG.Connector {
        async fetchCustomerState() {
            return Promise.resolve({
                loggedIn: true,

                balance: {
                    amountInMinor: 5000,
                    amountInMajor: 50.00,
                    currency: 'EUR',
                }
            });
        }

        executeHttpRequest(req) {
            return fakeRequestHandler(req);
        }

        updateUIState(state) {
            logEvent("UIState", state);
        }
    }

    function createGameActions(game) {
        const actions = {
            "play game": () => game.playGame(),
            "play demo game": () => game.playDemoGame(),
        };

        for (let name in actions) {
            const action = actions[name];

            const button = document.createElement("input");
            button.type = "button";
            button.onclick = () => action();
            button.value = name;

            const container = document.querySelector("#sendCommands");
            container.appendChild(button);
        }
    }

    window.onload = async () => {
        const gameConfig = {
            canonicalGameName: "demo",
            overlay: false,
        };

        const container = document.querySelector("#game");
        const game = ZIG.installGame({
            container: container,
            url: `https://mylotto24.frontend.zig.services/${gameName}/latest/tipp24_com/game/outer.html`,
            gameConfig: gameConfig,
            connector: new Connector(),
        });

        // log all events.
        game.rawMessageClient.register(event => logEvent("Event", event));

        await game.initialize(gameData.gameInput || undefined);
        createGameActions(game);
    };


</script>
</body>

</html>